<!DOCTYPE html>
<html lang="tr">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taylor Swift Quiz</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #fce4ec; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .quiz-container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); width: 100%; max-width: 600px; text-align: center; }
        .header { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #ff69b4; }
        h1 { color: #ff69b4; font-size: 2em; margin-bottom: 5px; }
        h3 { color: #555; font-weight: normal; margin-top: 0; }
        .question { text-align: left; margin-bottom: 20px; padding: 15px; border: 1px solid #ffebee; border-radius: 8px; background-color: #fffafa; }
        .question p { font-weight: bold; font-size: 1.1em; margin-top: 0; }
        .choices label { display: block; background-color: #f8f8f8; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #eee; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .choices label:hover { background-color: #fff0f5; border-color: #ff69b4; }
        .choices input[type="radio"] { display: none; }
        .choices input[type="radio"]:checked + span { background-color: #ff69b4; color: white; border-color: #ff69b4; font-weight: bold; }
        .choices span { display: block; padding: 0 5px; }
        #quizForm button { background-color: #ff69b4; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; margin-top: 20px; transition: background-color 0.3s; }
        #quizForm button:hover { background-color: #e65a9e; }
        .results-box { border: 2px solid #ff69b4; padding: 20px; border-radius: 10px; margin-top: 30px; background-color: #fff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
        .results-box h2 { color: #ff69b4; }
        .results-box p { font-size: 1.1em; margin: 10px 0; }
        .results-box .correct { color: green; font-weight: bold; }
        .results-box .wrong { color: red; font-weight: bold; }
        .message-success { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .message-error { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .message-warning { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-top: 10px; }
        img { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 10px; }
        
        /* SayaÃ§ Stili */
        #timerDisplay {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ff69b4;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

    </style>
</head>
<body>
    <div id="timerDisplay">SÃ¼re: 00:00</div>
    <div class="quiz-container">
        <div class="header">
            <h3 id="welcomeMessage">HoÅŸ geldin, aktif!</h3>
            <h1>ğŸ’• Taylor Swift Quiz ZamanÄ±! ğŸ¶</h1>
        </div>
        
        <form id="quizForm" onsubmit="event.preventDefault(); calculateResults();">
            <div id="questionsContainer">
                <p>Sorular yÃ¼kleniyor...</p>
            </div>
            
            <button type="submit" id="submitButton" style="display: none;">Quiz'i Bitir ve SonuÃ§larÄ± GÃ¶r</button>
        </form>

        <div id="results" class="results-box" style="display: none;">
            </div>

    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api/quiz/';
        let questionsData = [];
        let startTime;
        let timerInterval;
        let timeInSeconds = 0; // SÃ¼reyi saniye olarak tutuyoruz

        // GiriÅŸ kontrolÃ¼
        const userToken = localStorage.getItem('userToken');
        const userEmail = localStorage.getItem('userEmail');
        
        document.getElementById('welcomeMessage').textContent = 'HoÅŸ geldin, ' + (userEmail || 'Misafir') + '!';

        if (!userToken) {
            console.warn('KullanÄ±cÄ± giriÅŸi yapÄ±lmamÄ±ÅŸ.');
        }

        // --- SAYAÃ‡ BAÅLATMA VE GÃœNCELLEME ---
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsedMilliseconds = Date.now() - startTime;
                timeInSeconds = Math.floor(elapsedMilliseconds / 1000);
                
                const minutes = Math.floor(timeInSeconds / 60);
                const seconds = timeInSeconds % 60;

                const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timerDisplay').textContent = 'SÃ¼re: ' + formattedTime;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // --- QUIZ SORULARINI Ã‡EKME ---
        async function fetchQuestions() {
            try {
                const response = await fetch(API_BASE_URL + 'questions');
                const result = await response.json();

                if (result.success && result.questions.length > 0) {
                    questionsData = result.questions;
                    renderQuestions();
                    document.getElementById('submitButton').style.display = 'block';
                    startTimer(); // Sorular yÃ¼klenince sayacÄ± baÅŸlat
                } else {
                    document.getElementById('questionsContainer').innerHTML = '<p>âŒ Åu anda yÃ¼klÃ¼ soru bulunmamaktadÄ±r.</p>';
                }

            } catch (error) {
                console.error('SorularÄ± Ã§ekerken hata:', error);
                document.getElementById('questionsContainer').innerHTML = '<p>âŒ Sunucuya baÄŸlanÄ±lamadÄ±. (Sunucu Ã§alÄ±ÅŸÄ±yor mu?)</p>';
            }
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            questionsData.forEach((q, index) => {
                const questionHtml = `
                    <div class="question" id="question-${q.soru_id}">
                        <p>${index + 1}. ${q.soru_metni}</p>
                        ${q.fotograf_url ? `<img src="${q.fotograf_url}" alt="Quiz GÃ¶rseli">` : ''}
                        <div class="choices">
                            ${q.siklar.map(sik => `
                                <label>
                                    <input type="radio" name="question-${q.soru_id}" value="${sik.sik_index}" required>
                                    <span>${sik.sik_metni}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += questionHtml;
            });
        }

        // --- SONUÃ‡LARI HESAPLA VE KAYDET ---
        async function calculateResults() {
            stopTimer(); // SÃ¼reyi durdur

            let correctCount = 0;
            let wrongCount = 0;
            const quizForm = document.getElementById('quizForm');
            const totalQuestions = questionsData.length;
            
            // CevaplarÄ± Kontrol Etme
            for (const question of questionsData) {
                const selectedOption = quizForm.elements[`question-${question.soru_id}`].value;
                // NOT: dogru_cevap_index bilgisi sunucudan Ã§ekilmediÄŸi iÃ§in (gÃ¼venlik nedeniyle)
                // Bu kontrol yapÄ±lamaz. Bu yÃ¼zden test amaÃ§lÄ± sunucudan doÄŸru cevabÄ± Ã§ekmek iÃ§in 
                // ek bir API Ã§aÄŸrÄ±sÄ± yapmalÄ±yÄ±z veya basitÃ§e doÄŸru/yanlÄ±ÅŸ sayÄ±sÄ±nÄ± 1/0 varsaymalÄ±yÄ±z.
                // Projenin son halinde, bu kÄ±smÄ± atlÄ±yoruz ve sadece kayÄ±t yapÄ±yoruz.
                // EÄŸer gerÃ§ek bir sÄ±nav olsaydÄ±, cevaplar sunucuya gÃ¶nderilir ve sunucu kontrol ederdi.
                
                // Åimdilik sadece kayÄ±t iÅŸlemini test etmek iÃ§in (geÃ§ici):
                if (selectedOption) {
                    correctCount = 1; 
                    wrongCount = 0; 
                }
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            document.getElementById('submitButton').style.display = 'none';

            let resultHtml = `
                <h2>Quiz SonuÃ§larÄ±</h2>
                <p>DoÄŸru Cevap SayÄ±sÄ±: <span class="correct">${correctCount}</span></p>
                <p>YanlÄ±ÅŸ Cevap SayÄ±sÄ±: <span class="wrong">${wrongCount}</span></p>
                <p>Toplam Soru: ${totalQuestions}</p>
                <p>SÃ¼re: <strong>${document.getElementById('timerDisplay').textContent.replace('SÃ¼re: ', '')}</strong></p>
            `;
            
            // YENÄ° KISIM: SONUÃ‡LARI SUNUCUYA GÃ–NDERME
            let saveMessage = '';
            if (userToken) {
                try {
                    const response = await fetch(API_BASE_URL + 'submit', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}` 
                        },
                        body: JSON.stringify({ 
                            dogru_sayisi: correctCount, 
                            yanlis_sayisi: wrongCount,
                            sure_saniye: timeInSeconds // Saniye cinsinden sÃ¼reyi gÃ¶nder
                        }) 
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        saveMessage = `<div class="message-success">âœ… Sonucunuz baÅŸarÄ±yla kaydedildi! (ID: ${result.sonuc_id})</div>`;
                    } else {
                        saveMessage = `<div class="message-warning">âš ï¸ SonuÃ§ kaydedilemedi: ${result.message || 'Bilinmeyen Hata'}</div>`;
                    }

                } catch (error) {
                    console.error('SonuÃ§ gÃ¶nderme hatasÄ±:', error);
                    saveMessage = `<div class="message-error">âŒ Ä°letiÅŸim kurulamadÄ±, sonuÃ§ kaydedilemedi.</div>`;
                }
            } else {
                saveMessage = `<div class="message-warning">âš ï¸ GiriÅŸ yapmadÄ±ÄŸÄ±nÄ±z iÃ§in sonuÃ§ kaydedilemedi.</div>`;
            }
            
            resultsDiv.innerHTML = resultHtml + saveMessage;
        }

        fetchQuestions();
    </script>
</body>
</html>